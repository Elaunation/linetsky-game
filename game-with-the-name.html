<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Game With The Name</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #f3e8ff 100%);
            min-height: 100vh;
            padding: 2rem 1rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            font-family: serif;
            margin-bottom: 2rem;
            color: #1f2937;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        input[type="text"] {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #3b82f6;
        }

        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #4b5563;
        }

        .btn-purple {
            background: #8b5cf6;
            color: white;
        }

        .btn-purple:hover:not(:disabled) {
            background: #7c3aed;
        }

        .player-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
        }

        .player-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .timer-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
        }

        .timer-value {
            font-size: 2rem;
            font-weight: bold;
            width: 120px;
            text-align: center;
        }

        .timer-display {
            font-size: 3rem;
            font-weight: bold;
            text-align: center;
            color: #1f2937;
        }

        .timer-display.warning {
            color: #ef4444;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .letter-pair-item {
            border: 2px solid #d1d5db;
            border-radius: 8px;
            padding: 1rem;
        }

        .letter-pair-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .letter-label {
            font-weight: bold;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .letter-pair-box {
            font-size: 1.5rem;
            font-weight: bold;
            background: #f3f4f6;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-align: center;
            min-width: 60px;
        }

        .validation-valid {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .validation-invalid {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .validation-message {
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .validation-valid .validation-message {
            color: #10b981;
        }

        .validation-invalid .validation-message {
            color: #ef4444;
        }

        .player-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
        }

        .current-player {
            text-align: center;
        }

        .current-player-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
        }

        .player-count {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .score-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-radius: 8px;
            background: #f9fafb;
        }

        .score-item.rank-1 {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
        }

        .score-item.rank-2 {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        }

        .score-item.rank-3 {
            background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
        }

        .rank-number {
            font-size: 2rem;
            font-weight: bold;
            color: #9ca3af;
            margin-right: 1rem;
        }

        .score-value {
            font-size: 2rem;
            font-weight: bold;
            color: #3b82f6;
        }

        .winner-banner {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 3rem 2rem;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 2rem;
        }

        .winner-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .winner-title {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .winner-subtitle {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .celeb-image {
            max-width: 300px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            margin: 0 auto;
            display: block;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
            color: #6b7280;
        }

        .loading::after {
            content: '...';
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .title {
                font-size: 1.5rem;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .timer-value {
                font-size: 1.5rem;
            }

            .winner-title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Setup Screen -->
        <div id="setupScreen">
            <div class="title">‚ô¶‚ô¶‚ô¶ THE ‚ô¶ GAME ‚ô¶ WITH ‚ô¶ THE ‚ô¶ NAME ‚ô¶‚ô¶‚ô¶</div>

            <!-- Players -->
            <div class="card">
                <h2 class="section-title">
                    üë• Players (<span id="playerCount">0</span>/6)
                </h2>
                <div class="input-group">
                    <input type="text" id="playerNameInput" placeholder="Enter player/group name" maxlength="30">
                    <button class="btn-primary" onclick="addPlayer()">Add</button>
                </div>
                <div class="player-list" id="playerList"></div>
            </div>

            <!-- Input Sentence -->
            <div class="card">
                <h2 class="section-title">Input Sentence</h2>
                <input type="text" id="sentenceInput" placeholder="e.g., Cat Ate Rice">
            </div>

            <!-- Timer Setting -->
            <div class="card">
                <h2 class="section-title">‚è∞ Timer Duration</h2>
                <div class="timer-controls">
                    <button class="btn-secondary" onclick="adjustTimer(-1)">-</button>
                    <div class="timer-value"><span id="timerMinutes">7</span> min</div>
                    <button class="btn-secondary" onclick="adjustTimer(1)">+</button>
                </div>
            </div>

            <!-- Start Button -->
            <button class="btn-success" style="width: 100%; padding: 1.5rem; font-size: 1.25rem;" onclick="startGame()">
                ‚ñ∂ Start Game
            </button>
        </div>

        <!-- Gameplay Screen -->
        <div id="gameplayScreen" class="hidden">
            <!-- Header -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h1 style="font-size: 2rem; font-weight: bold;">Round <span id="currentRound">1</span></h1>
                    <div class="timer-display" id="timerDisplay">7:00</div>
                </div>
                <div style="color: #6b7280;">
                    Sentence: <span style="font-weight: bold;" id="gameSentence"></span>
                </div>
            </div>

            <!-- Player Navigation -->
            <div class="card">
                <div class="player-nav">
                    <button class="btn-secondary" onclick="prevPlayer()" id="prevBtn">‚Üê Previous</button>
                    <div class="current-player">
                        <div style="font-size: 0.875rem; color: #6b7280;">Current Player</div>
                        <div class="current-player-name" id="currentPlayerName"></div>
                        <div class="player-count" id="playerProgress"></div>
                    </div>
                    <button class="btn-secondary" onclick="nextPlayer()" id="nextBtn">Next ‚Üí</button>
                </div>
            </div>

            <!-- Letter Pairs Grid -->
            <div class="card">
                <div class="grid" id="letterPairsGrid"></div>
            </div>

            <!-- Validation Button -->
            <div class="card">
                <button class="btn-purple" style="width: 100%; padding: 1rem;" onclick="validateAnswers()" id="validateBtn">
                    ‚úì Check Names (1 per round)
                </button>
            </div>

            <!-- End Round Button -->
            <button class="btn-danger" style="width: 100%; padding: 1rem;" onclick="endRound()">
                End Round (Admin)
            </button>
        </div>

        <!-- Round End Screen -->
        <div id="roundEndScreen" class="hidden">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h1 style="font-size: 2.5rem; font-weight: bold;">Round <span id="endRoundNumber">1</span> Complete!</h1>
            </div>

            <!-- Scores -->
            <div class="card">
                <h2 class="section-title">üèÜ Round <span id="scoreRoundNumber">1</span> Scores</h2>
                <div class="score-list" id="roundScoresList"></div>
            </div>

            <!-- Player Navigation & Ready -->
            <div class="card">
                <div class="player-nav" style="margin-bottom: 1rem;">
                    <button class="btn-secondary" onclick="prevPlayerRoundEnd()" id="prevBtnRoundEnd">‚Üê Previous Player</button>
                    <div class="current-player">
                        <div class="current-player-name" id="currentPlayerNameRoundEnd"></div>
                        <div class="player-count" id="playerProgressRoundEnd"></div>
                    </div>
                    <button class="btn-secondary" onclick="nextPlayerRoundEnd()" id="nextBtnRoundEnd">Next Player ‚Üí</button>
                </div>
                <button class="btn-success" style="width: 100%; padding: 1.5rem; font-size: 1.25rem;" onclick="playerReady()" id="readyBtn">
                    Ready for Round 2
                </button>
                <div style="text-align: center; margin-top: 1rem; color: #6b7280;">
                    <span id="readyCount">0</span> of <span id="totalPlayers">0</span> players ready
                </div>
            </div>
        </div>

        <!-- Final Screen -->
        <div id="finalScreen" class="hidden">
            <div class="winner-banner">
                <div class="winner-icon">üèÜ</div>
                <div class="winner-title">Game Over!</div>
                <div class="winner-subtitle" id="winnerText"></div>
                <div style="font-size: 1.25rem;" id="winnerScore"></div>
            </div>

            <!-- Celebrity Image -->
            <div id="celebImageCard" class="card hidden" style="text-align: center;">
                <h2 class="section-title" style="justify-content: center;" id="celebName"></h2>
                <img id="celebImage" class="celeb-image" alt="Celebrity">
            </div>

            <!-- Final Scores -->
            <div class="card">
                <h2 class="section-title">Final Scores</h2>
                <div class="score-list" id="finalScoresList"></div>
            </div>

            <!-- Reset Button -->
            <button class="btn-primary" style="width: 100%; padding: 1.5rem; font-size: 1.25rem;" onclick="resetGame()">
                üîÑ New Game
            </button>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="hidden">
            <div class="card">
                <div class="loading">Validating names</div>
            </div>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            screen: 'setup', // setup, gameplay, roundEnd, final
            players: [],
            currentPlayerIndex: 0,
            inputSentence: '',
            timerDuration: 7,
            timeRemaining: 0,
            round: 1,
            letterPairs: [],
            playerAnswers: {},
            scores: {},
            validationUsed: {},
            validationResults: {},
            readyPlayers: new Set(),
            timerInterval: null
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('playerNameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addPlayer();
            });
        });

        // Setup Functions
        function addPlayer() {
            const input = document.getElementById('playerNameInput');
            const name = input.value.trim();
            
            if (!name) {
                alert('Please enter a player name!');
                return;
            }
            
            if (gameState.players.length >= 6) {
                alert('Maximum 6 players allowed!');
                return;
            }
            
            const playerId = 'player-' + Date.now();
            gameState.players.push({ id: playerId, name: name });
            gameState.scores[playerId] = { round1: 0, round2: 0, total: 0 };
            gameState.playerAnswers[playerId] = {};
            gameState.validationUsed[playerId] = { round1: false, round2: false };
            
            input.value = '';
            renderPlayerList();
        }

        function removePlayer(playerId) {
            gameState.players = gameState.players.filter(p => p.id !== playerId);
            delete gameState.scores[playerId];
            delete gameState.playerAnswers[playerId];
            delete gameState.validationUsed[playerId];
            renderPlayerList();
        }

        function renderPlayerList() {
            const list = document.getElementById('playerList');
            const count = document.getElementById('playerCount');
            count.textContent = gameState.players.length;
            
            if (gameState.players.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 2rem;">No players added yet</div>';
                return;
            }
            
            list.innerHTML = gameState.players.map(player => `
                <div class="player-item">
                    <span class="player-name">${player.name}</span>
                    <button class="btn-danger" onclick="removePlayer('${player.id}')">Remove</button>
                </div>
            `).join('');
        }

        function adjustTimer(delta) {
            const current = gameState.timerDuration;
            const newValue = Math.max(5, Math.min(10, current + delta));
            gameState.timerDuration = newValue;
            document.getElementById('timerMinutes').textContent = newValue;
        }

        // Generate letter pairs
        function generateLetterPairs(sentence, round) {
            const letters = sentence.replace(/\s+/g, '').toUpperCase().split('');
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            
            return letters.map((letter, index) => {
                if (index >= alphabet.length) return null;
                const alphabetLetter = alphabet[index];
                
                if (round === 1) {
                    return alphabetLetter + letter;
                } else {
                    return letter + alphabetLetter;
                }
            }).filter(pair => pair !== null);
        }

        // Start Game
        function startGame() {
            if (gameState.players.length === 0) {
                alert('Please add at least one player!');
                return;
            }
            
            const sentence = document.getElementById('sentenceInput').value.trim();
            if (!sentence) {
                alert('Please enter a sentence!');
                return;
            }
            
            gameState.inputSentence = sentence;
            gameState.letterPairs = generateLetterPairs(sentence, 1);
            gameState.timeRemaining = gameState.timerDuration * 60;
            gameState.currentPlayerIndex = 0;
            gameState.round = 1;
            
            // Initialize answers
            gameState.players.forEach(player => {
                gameState.playerAnswers[player.id] = {};
                gameState.letterPairs.forEach(pair => {
                    gameState.playerAnswers[player.id][pair] = '';
                });
            });
            
            gameState.validationResults = {};
            showScreen('gameplay');
            renderGameplay();
            startTimer();
        }

        // Timer
        function startTimer() {
            if (gameState.timerInterval) clearInterval(gameState.timerInterval);
            
            gameState.timerInterval = setInterval(() => {
                gameState.timeRemaining--;
                updateTimerDisplay();
                
                if (gameState.timeRemaining <= 0) {
                    endRound();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const mins = Math.floor(gameState.timeRemaining / 60);
            const secs = gameState.timeRemaining % 60;
            const display = document.getElementById('timerDisplay');
            display.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            
            if (gameState.timeRemaining < 60) {
                display.classList.add('warning');
            } else {
                display.classList.remove('warning');
            }
        }

        // Gameplay
        function renderGameplay() {
            document.getElementById('currentRound').textContent = gameState.round;
            document.getElementById('gameSentence').textContent = gameState.inputSentence;
            updatePlayerNav();
            renderLetterPairs();
            updateValidateButton();
        }

        function updatePlayerNav() {
            const player = gameState.players[gameState.currentPlayerIndex];
            document.getElementById('currentPlayerName').textContent = player.name;
            document.getElementById('playerProgress').textContent = 
                `Player ${gameState.currentPlayerIndex + 1} of ${gameState.players.length}`;
            
            document.getElementById('prevBtn').disabled = gameState.currentPlayerIndex === 0;
            document.getElementById('nextBtn').disabled = gameState.currentPlayerIndex === gameState.players.length - 1;
        }

        function renderLetterPairs() {
            const grid = document.getElementById('letterPairsGrid');
            const player = gameState.players[gameState.currentPlayerIndex];
            const answers = gameState.playerAnswers[player.id];
            const validation = gameState.validationResults[player.id] || {};
            
            grid.innerHTML = gameState.letterPairs.map((pair, index) => {
                const answer = answers[pair] || '';
                const validationStatus = validation[pair];
                const validClass = validationStatus === true ? 'validation-valid' : 
                                   validationStatus === false ? 'validation-invalid' : '';
                
                return `
                    <div class="letter-pair-item ${validClass}">
                        <div class="letter-pair-header">
                            <div>
                                <div class="letter-label">${String.fromCharCode(65 + index)}</div>
                                <div class="letter-pair-box">${pair}</div>
                            </div>
                            <input type="text" 
                                   value="${answer}" 
                                   placeholder="Famous person name"
                                   oninput="updateAnswer('${pair}', this.value)"
                                   style="flex: 1;">
                        </div>
                        ${validationStatus === true ? '<div class="validation-message">‚úì Valid name</div>' : ''}
                        ${validationStatus === false ? '<div class="validation-message">‚úó Invalid name</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        function updateAnswer(pair, value) {
            const player = gameState.players[gameState.currentPlayerIndex];
            gameState.playerAnswers[player.id][pair] = value;
        }

        function updateValidateButton() {
            const player = gameState.players[gameState.currentPlayerIndex];
            const roundKey = gameState.round === 1 ? 'round1' : 'round2';
            const hasUsed = gameState.validationUsed[player.id][roundKey];
            
            const btn = document.getElementById('validateBtn');
            btn.disabled = hasUsed;
            btn.textContent = hasUsed ? 'Validation Used' : '‚úì Check Names (1 per round)';
        }

        function prevPlayer() {
            if (gameState.currentPlayerIndex > 0) {
                gameState.currentPlayerIndex--;
                renderGameplay();
            }
        }

        function nextPlayer() {
            if (gameState.currentPlayerIndex < gameState.players.length - 1) {
                gameState.currentPlayerIndex++;
                renderGameplay();
            }
        }

        // Validation
        async function validateAnswers() {
            const player = gameState.players[gameState.currentPlayerIndex];
            const roundKey = gameState.round === 1 ? 'round1' : 'round2';
            
            if (gameState.validationUsed[player.id][roundKey]) {
                alert('You have already used your validation check for this round!');
                return;
            }
            
            showLoading(true);
            
            const answers = gameState.playerAnswers[player.id];
            const results = {};
            
            for (const [pair, name] of Object.entries(answers)) {
                if (name.trim()) {
                    results[pair] = await validateName(name);
                } else {
                    results[pair] = null;
                }
            }
            
            if (!gameState.validationResults[player.id]) {
                gameState.validationResults[player.id] = {};
            }
            Object.assign(gameState.validationResults[player.id], results);
            
            gameState.validationUsed[player.id][roundKey] = true;
            
            showLoading(false);
            renderGameplay();
        }

        async function validateName(name) {
            if (!name.trim()) return false;
            
            try {
                const response = await fetch(
                    `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(name.trim())}`
                );
                
                if (response.ok) {
                    const data = await response.json();
                    return data.type === 'standard' && data.extract && data.extract.length > 0;
                }
                return false;
            } catch (error) {
                console.error('Validation error:', error);
                return false;
            }
        }

        // End Round
        async function endRound() {
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
                gameState.timerInterval = null;
            }
            
            showLoading(true);
            
            const roundKey = gameState.round === 1 ? 'round1' : 'round2';
            
            // Validate all answers
            for (const player of gameState.players) {
                let roundScore = 0;
                const answers = gameState.playerAnswers[player.id];
                
                for (const [pair, name] of Object.entries(answers)) {
                    if (name.trim()) {
                        const isValid = await validateName(name);
                        if (isValid) roundScore++;
                    }
                }
                
                gameState.scores[player.id][roundKey] = roundScore;
                gameState.scores[player.id].total = 
                    gameState.scores[player.id].round1 + gameState.scores[player.id].round2;
            }
            
            showLoading(false);
            
            if (gameState.round === 1) {
                gameState.currentPlayerIndex = 0;
                gameState.readyPlayers.clear();
                showScreen('roundEnd');
                renderRoundEnd();
            } else {
                await showFinal();
            }
        }

        // Round End
        function renderRoundEnd() {
            document.getElementById('endRoundNumber').textContent = gameState.round;
            document.getElementById('scoreRoundNumber').textContent = gameState.round;
            
            // Render scores
            const sortedPlayers = [...gameState.players].sort((a, b) => 
                gameState.scores[b.id].round1 - gameState.scores[a.id].round1
            );
            
            const scoresList = document.getElementById('roundScoresList');
            scoresList.innerHTML = sortedPlayers.map((player, index) => {
                const rank = index + 1;
                const rankClass = rank <= 3 ? `rank-${rank}` : '';
                
                return `
                    <div class="score-item ${rankClass}">
                        <div style="display: flex; align-items: center;">
                            <span class="rank-number">#${rank}</span>
                            <span style="font-size: 1.25rem; font-weight: bold;">${player.name}</span>
                        </div>
                        <div class="score-value">${gameState.scores[player.id].round1}</div>
                    </div>
                `;
            }).join('');
            
            updatePlayerNavRoundEnd();
        }

        function updatePlayerNavRoundEnd() {
            const player = gameState.players[gameState.currentPlayerIndex];
            const isReady = gameState.readyPlayers.has(player.id);
            
            document.getElementById('currentPlayerNameRoundEnd').textContent = player.name;
            document.getElementById('playerProgressRoundEnd').textContent = 
                `Player ${gameState.currentPlayerIndex + 1} of ${gameState.players.length}`;
            
            document.getElementById('prevBtnRoundEnd').disabled = gameState.currentPlayerIndex === 0;
            document.getElementById('nextBtnRoundEnd').disabled = 
                gameState.currentPlayerIndex === gameState.players.length - 1;
            
            const readyBtn = document.getElementById('readyBtn');
            readyBtn.disabled = isReady;
            readyBtn.textContent = isReady ? '‚úì Ready!' : 'Ready for Round 2';
            
            document.getElementById('readyCount').textContent = gameState.readyPlayers.size;
            document.getElementById('totalPlayers').textContent = gameState.players.length;
        }

        function prevPlayerRoundEnd() {
            if (gameState.currentPlayerIndex > 0) {
                gameState.currentPlayerIndex--;
                updatePlayerNavRoundEnd();
            }
        }

        function nextPlayerRoundEnd() {
            if (gameState.currentPlayerIndex < gameState.players.length - 1) {
                gameState.currentPlayerIndex++;
                updatePlayerNavRoundEnd();
            }
        }

        function playerReady() {
            const player = gameState.players[gameState.currentPlayerIndex];
            gameState.readyPlayers.add(player.id);
            updatePlayerNavRoundEnd();
            
            if (gameState.readyPlayers.size === gameState.players.length) {
                startRound2();
            }
        }

        function startRound2() {
            gameState.round = 2;
            gameState.letterPairs = generateLetterPairs(gameState.inputSentence, 2);
            gameState.timeRemaining = gameState.timerDuration * 60;
            gameState.currentPlayerIndex = 0;
            
            // Initialize answers for round 2
            gameState.players.forEach(player => {
                gameState.playerAnswers[player.id] = {};
                gameState.letterPairs.forEach(pair => {
                    gameState.playerAnswers[player.id][pair] = '';
                });
            });
            
            gameState.validationResults = {};
            showScreen('gameplay');
            renderGameplay();
            startTimer();
        }

        // Final Screen
        async function showFinal() {
            // Determine winner
            let maxScore = -1;
            let winners = [];
            
            gameState.players.forEach(player => {
                const score = gameState.scores[player.id].total;
                if (score > maxScore) {
                    maxScore = score;
                    winners = [player];
                } else if (score === maxScore) {
                    winners.push(player);
                }
            });
            
            // Get random celebrity image
            let celebName = null;
            let imageUrl = null;
            
            for (const winner of winners) {
                const allAnswers = [
                    ...Object.values(gameState.playerAnswers[winner.id] || {})
                ].filter(a => a && a.trim());
                
                if (allAnswers.length > 0) {
                    const randomAnswer = allAnswers[Math.floor(Math.random() * allAnswers.length)];
                    if (await validateName(randomAnswer)) {
                        celebName = randomAnswer;
                        try {
                            const response = await fetch(
                                `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(randomAnswer)}`
                            );
                            if (response.ok) {
                                const data = await response.json();
                                imageUrl = data.thumbnail?.source || data.originalimage?.source || null;
                            }
                        } catch (error) {
                            console.error('Error fetching image:', error);
                        }
                        break;
                    }
                }
            }
            
            // Render final screen
            showScreen('final');
            
            const winnerText = winners.length === 1 ? 
                `Winner: ${winners[0].name}` : 
                `Tie between: ${winners.map(w => w.name).join(', ')}`;
            
            document.getElementById('winnerText').textContent = winnerText;
            document.getElementById('winnerScore').textContent = `Total Score: ${maxScore} points`;
            
            // Show celebrity image if available
            if (imageUrl && celebName) {
                document.getElementById('celebImageCard').classList.remove('hidden');
                document.getElementById('celebName').textContent = `Featured Name: ${celebName}`;
                document.getElementById('celebImage').src = imageUrl;
            } else {
                document.getElementById('celebImageCard').classList.add('hidden');
            }
            
            // Render final scores
            const sortedPlayers = [...gameState.players].sort((a, b) => 
                gameState.scores[b.id].total - gameState.scores[a.id].total
            );
            
            const finalList = document.getElementById('finalScoresList');
            finalList.innerHTML = sortedPlayers.map((player, index) => {
                const rank = index + 1;
                const rankClass = rank <= 3 ? `rank-${rank}` : '';
                const score = gameState.scores[player.id];
                
                return `
                    <div class="score-item ${rankClass}">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span class="rank-number">#${rank}</span>
                            <div>
                                <div style="font-size: 1.25rem; font-weight: bold;">${player.name}</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">
                                    Round 1: ${score.round1} | Round 2: ${score.round2}
                                </div>
                            </div>
                        </div>
                        <div class="score-value">${score.total}</div>
                    </div>
                `;
            }).join('');
        }

        // Reset Game
        function resetGame() {
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
                gameState.timerInterval = null;
            }
            
            gameState = {
                screen: 'setup',
                players: [],
                currentPlayerIndex: 0,
                inputSentence: '',
                timerDuration: 7,
                timeRemaining: 0,
                round: 1,
                letterPairs: [],
                playerAnswers: {},
                scores: {},
                validationUsed: {},
                validationResults: {},
                readyPlayers: new Set(),
                timerInterval: null
            };
            
            document.getElementById('sentenceInput').value = '';
            document.getElementById('timerMinutes').textContent = '7';
            renderPlayerList();
            showScreen('setup');
        }

        // UI Helpers
        function showScreen(screen) {
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('gameplayScreen').classList.add('hidden');
            document.getElementById('roundEndScreen').classList.add('hidden');
            document.getElementById('finalScreen').classList.add('hidden');
            
            if (screen === 'setup') {
                document.getElementById('setupScreen').classList.remove('hidden');
            } else if (screen === 'gameplay') {
                document.getElementById('gameplayScreen').classList.remove('hidden');
            } else if (screen === 'roundEnd') {
                document.getElementById('roundEndScreen').classList.remove('hidden');
            } else if (screen === 'final') {
                document.getElementById('finalScreen').classList.remove('hidden');
            }
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
